name: Release
on:
  workflow_dispatch:
  push:
    branches: [main]
env:
  RESOURCE_PUBLISHER_TOKEN: ${{ secrets.RESOURCE_PUBLISHER_TOKEN }}
  WOLFRAMSCRIPT_ENTITLEMENTID: ${{ secrets.WOLFRAMSCRIPT_ENTITLEMENTID }}
  WLPR_PACLET_SITE: https://resources.wolframcloud.com/PacletRepository/pacletsite
  ENGINE_TAG: 14.3.0
  PACLET_CICD_VERSION: 0.36.2
jobs:
  Check:
    name: Check
    runs-on: ubuntu-latest
    container:
      image: wolframresearch/wolframengine:14.3.0
      options: --user root
    env:
      WOLFRAM_SYSTEM_ID: Linux-x86-64
    steps:
      - name: Checkout
        id: checkout-code-step
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Check
        id: check-paclet-step
        uses: WolframResearch/check-paclet@v1.11.0
        with:
          target: Submit
          paclet_cicd_version: ${{ env.PACLET_CICD_VERSION }}
          definition_notebook: ./ResourceDefinition.nb
          resource_system_base: https://www.wolframcloud.com/obj/resourcesystem/api/1.0
        env:
          WOLFRAMSCRIPT_ENTITLEMENTID: ${{ secrets.WOLFRAMSCRIPT_ENTITLEMENTID }}
          RESOURCE_PUBLISHER_TOKEN: ${{ secrets.RESOURCE_PUBLISHER_TOKEN }}
      - name: UploadWorkflowValues
        id: upload-workflow-values-step
        if: always() && env.PACLET_WORKFLOW_VALUES
        uses: actions/upload-artifact@v5
        with:
          name: paclet-workflow-values
          path: ${{ env.PACLET_WORKFLOW_VALUES }}
          if-no-files-found: ignore
  Test:
    name: Test
    runs-on: ubuntu-latest
    container:
      image: wolframresearch/wolframengine:14.3.0
      options: --user root
    env:
      WOLFRAM_SYSTEM_ID: Linux-x86-64
    steps:
      - name: Checkout
        id: checkout-code-step
        uses: actions/checkout@v5
      - name: Test
        id: test-paclet-step
        uses: WolframResearch/test-paclet@v1.11.0
        with:
          target: Submit
          paclet_cicd_version: ${{ env.PACLET_CICD_VERSION }}
          definition_notebook: ./ResourceDefinition.nb
          resource_system_base: https://www.wolframcloud.com/obj/resourcesystem/api/1.0
        env:
          WOLFRAMSCRIPT_ENTITLEMENTID: ${{ secrets.WOLFRAMSCRIPT_ENTITLEMENTID }}
          RESOURCE_PUBLISHER_TOKEN: ${{ secrets.RESOURCE_PUBLISHER_TOKEN }}
      - name: UploadWorkflowValues
        id: upload-workflow-values-step
        if: always() && env.PACLET_WORKFLOW_VALUES
        uses: actions/upload-artifact@v5
        with:
          name: paclet-workflow-values
          path: ${{ env.PACLET_WORKFLOW_VALUES }}
          if-no-files-found: ignore
  Release:
    name: Release
    needs: [Check, Test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    concurrency:
      group: release-${{ github.repository }}
      cancel-in-progress: true
    container:
      image: wolframresearch/wolframengine:14.3.0
      options: --user root
    env:
      WOLFRAM_SYSTEM_ID: Linux-x86-64
      GIT_DISCOVERY_ACROSS_FILESYSTEM: 1
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}
    timeout-minutes: 360
    steps:
      - name: Install Git and GitHub CLI
        shell: bash
        run: |
          set -euo pipefail
          apt-get update -y
          apt-get install -y wget ca-certificates apt-transport-https
          mkdir -p -m 755 /etc/apt/keyrings
          wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg > /etc/apt/keyrings/githubcli-archive-keyring.gpg
          chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list
          apt-get update -y
          apt-get install -y gh git
      - name: Check Workflow Values Artifact
        id: check-workflow-values
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          if gh api "repos/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}/artifacts" --jq '.artifacts[].name' | grep -Fx 'paclet-workflow-values' >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Checkout
        id: checkout-code-step
        uses: actions/checkout@v5
      - name: DownloadWorkflowValues
        id: download-workflow-values-step
        if: steps.check-workflow-values.outputs.exists == 'true'
        uses: actions/download-artifact@v6
        with:
          name: paclet-workflow-values
          path: ${{ env.PACLET_WORKFLOW_VALUES }}
          merge-multiple: true
      - name: Build
        id: build-paclet-step
        uses: WolframResearch/build-paclet@v1.11.0
        with:
          target: Submit
          paclet_cicd_version: ${{ env.PACLET_CICD_VERSION }}
          definition_notebook: ./ResourceDefinition.nb
          resource_system_base: https://www.wolframcloud.com/obj/resourcesystem/api/1.0
        env:
          WOLFRAMSCRIPT_ENTITLEMENTID: ${{ secrets.WOLFRAMSCRIPT_ENTITLEMENTID }}
          RESOURCE_PUBLISHER_TOKEN: ${{ secrets.RESOURCE_PUBLISHER_TOKEN }}
      - name: UploadArtifact
        id: upload-build-artifacts-step
        uses: actions/upload-artifact@v5
        with:
          path: ${{ env.PACLET_BUILD_DIR }}
          if-no-files-found: ignore
      - name: Configure Git Safe Directory
        shell: bash
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - name: Enforce Immutable Tag
        id: enforce-immutable-tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY}"
          tag="${PACLET_RELEASE_TAG}"
          # If tag exists, ensure it points to this commit
          if gh api "repos/${repo}/git/ref/tags/${tag}" >/dev/null 2>&1; then
            type=$(gh api "repos/${repo}/git/ref/tags/${tag}" -q .object.type)
            refsha=$(gh api "repos/${repo}/git/ref/tags/${tag}" -q .object.sha)
            if [ "$type" = "tag" ]; then
              refsha=$(gh api "repos/${repo}/git/tags/${refsha}" -q .object.sha)
            fi
            if [ "$refsha" != "$GITHUB_SHA" ]; then
              echo "::error::Immutable tag policy: tag ${tag} exists at ${refsha}, current commit is ${GITHUB_SHA}. Bump Version in PacletInfo.wl (e.g., 1.0.1) to create a new release." ; exit 1
            fi
          fi
      - name: Prepare Release
        id: prepare-release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY}"
          tag="${PACLET_RELEASE_TAG}"
          asset_name="${PACLET_FILE}"
          if gh release view "$tag" --repo "$repo" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            # Check if asset already present
            if gh release view "$tag" --repo "$repo" --json assets -q '.assets[].name' | grep -Fx "$asset_name" >/dev/null 2>&1; then
              echo "asset_present=true" >> "$GITHUB_OUTPUT"
            else
              echo "asset_present=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "asset_present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Or Update Release
        id: create-or-update-release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY}"
          tag="${PACLET_RELEASE_TAG}"
          title="Release ${PACLET_RELEASE_TAG}"
          asset_spec="${PACLET_PATH}#${PACLET_FILE}"
          if [ "${{ steps.prepare-release.outputs.exists }}" = "true" ]; then
            echo "Release $tag exists; uploading asset (clobber)."
            gh release upload "$tag" "$asset_spec" --repo "$repo" --clobber
          else
            echo "Creating new published release $tag targeting $GITHUB_SHA."
            gh release create "$tag" "$asset_spec" \
              --repo "$repo" \
              --title "$title" \
              --target "$GITHUB_SHA"
          fi
          # Ensure release is published (not draft)
          is_draft=$(gh release view "$tag" --repo "$repo" --json isDraft -q '.isDraft')
          if [ "$is_draft" = "true" ]; then
            echo "Publishing draft release $tag."
            gh release edit "$tag" --repo "$repo" --draft=false --target "$GITHUB_SHA"
          fi

      - name: Verify Release Assets
        id: verify-release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY}"
          tag="${PACLET_RELEASE_TAG}"
          asset_name="${PACLET_FILE}"
          # Verify release exists
          gh release view "$tag" --repo "$repo" --json tagName >/dev/null
          # Verify asset present
          if ! gh release view "$tag" --repo "$repo" --json assets -q '.assets[].name' | grep -Fx "$asset_name" >/dev/null; then
            echo "::error::Asset $asset_name not found on release $tag" ; exit 1
          fi
      - name: Cleanup Old Draft Releases For Tag
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY}"
          tag="${PACLET_RELEASE_TAG}"
          # Gather draft releases matching the tag (may return empty/blank lines)
          ids=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "repos/${repo}/releases" --paginate \
            --jq ".[] | select(.draft == true and .tag_name == \"${tag}\") | .id" || true)
          # If nothing but whitespace, exit cleanly
          if [ -z "${ids//[[:space:]]/}" ]; then
            echo "No draft releases to delete for tag ${tag}"
            exit 0
          fi
          # Delete each non-empty id
          while IFS= read -r id; do
            [ -n "$id" ] || continue
            echo "Deleting old draft release id=${id} for tag ${tag}"
            gh api -X DELETE "repos/${repo}/releases/${id}"
          done <<< "$ids"
      - name: UploadWorkflowValues
        id: upload-workflow-values-step
        if: always() && env.PACLET_WORKFLOW_VALUES
        uses: actions/upload-artifact@v5
        with:
          name: paclet-workflow-values
          path: ${{ env.PACLET_WORKFLOW_VALUES }}
          if-no-files-found: ignore
