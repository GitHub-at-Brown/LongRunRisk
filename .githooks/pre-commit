#!/usr/bin/env bash
set -euo pipefail

if ! command -v wolframscript >/dev/null 2>&1; then
  echo "[pre-commit] wolframscript not found; cannot normalize notebooks" >&2
  exit 1
fi

ROOT="$(git rev-parse --show-toplevel)"
cd "$ROOT"

nb_files=()
while IFS= read -r file; do
  nb_files+=("$file")
done < <(git diff --cached --name-only --diff-filter=ACMR | grep -E '\\.nb$' || true)

if [ "${#nb_files[@]}" -eq 0 ]; then
  exit 0
fi

excludes=("ResourceDefinition.nb" "Tests/InteractiveTests/longRunRisk.nb")
filtered=()
for f in "${nb_files[@]}"; do
  skip=0
  for ex in "${excludes[@]}"; do
    if [ "$f" = "$ex" ]; then
      skip=1
      echo "[pre-commit] skipping $f (excluded)"
      break
    fi
  done
  if [ $skip -eq 0 ]; then
    filtered+=("$f")
  fi

done

nb_files=("${filtered[@]}")

if [ "${#nb_files[@]}" -eq 0 ]; then
  exit 0
fi

echo "[pre-commit] normalizing ${#nb_files[@]} notebook(s)"

if ! wolframscript -file "$ROOT/scripts/nb-clean.wls" "${nb_files[@]}"; then
  echo "[pre-commit] ERROR: notebook normalization failed" >&2
  exit 1
fi

for f in "${nb_files[@]}"; do
  if [ -f "$f" ]; then
    git add "$f"
  fi

done
